---
- name: Create new Virtual Machine in Proxmox [{{ _node }}] for Template
  become: yes
  gather_facts: No
  hosts: "{{ host }}"
  vars:
    ansible_python_interpreter: /usr/bin/python3
  collections:
    - community.general

  tasks:
    - name: Clone Virtual Machine
      proxmox_kvm:
        api_user: "{{ _api_user }}"
        api_password: "{{ hostvars[host].ansible_password }}"
        api_host: "{{ _api_host }}"
        clone: "{{ _vmid_template }}"
        vmid: "{{ _vmid_template }}"
        newid: "{{ _vmid }}"
        name: "{{ _hostname }}" # The target VM name
        node: "{{ _node }}"
        storage: local-lvm
        format: raw
        timeout: 300
      loop_control:
        pause: 5
