---
- name: Get all existing Virtual Machines in Proxmox [{{ node }}]
  register: all_vm
  community.general.proxmox_vm_info:
    api_host: "{{ api_host }}"
    api_user: "{{ api_user }}"
    node: "{{ node }}"
    api_password: "{{ hostvars['proxmox'].ansible_password }}"
    type: qemu

- name: Get all existing Containers in Proxmox [{{ node }}]
  register: all_ct
  community.general.proxmox_vm_info:
    api_host: "{{ api_host }}"
    api_user: "{{ api_user }}"
    node: "{{ node }}"
    api_password: "{{ hostvars['proxmox'].ansible_password }}"
    type: lxc

- set_fact:
    last_vm_name: "{{ all_vm.proxmox_vms | map(attribute='name') | list | last }}"
    last_vm_id: "{{ all_vm.proxmox_vms | map(attribute='vmid') | list | last }}"
    last_container_name: "{{ all_ct.proxmox_vms | map(attribute='name') | list | last }}"
    last_container_id: "{{ all_ct.proxmox_vms | map(attribute='vmid') | list | last }}"

- name: Get IP for Last Virtual Machine
  ansible.builtin.shell: set pipefail && awk -v IGNORECASE=1 '$1 == "ipconfig0:" { print }' /etc/pve/qemu-server/{{ last_vm_id }}.conf | cut -d'=' -f2 | cut -d'/' -f1
  register: last_vm_ip
  retries: 10
  delay: 10

- name: Get IP for Last Virtual Container
  ansible.builtin.shell: set pipefail && awk -v IGNORECASE=1 '$1 == "net0:" { print }' /etc/pve/lxc/{{ last_container_id }}.conf | cut -d',' -f5 | cut -d'=' -f2 | cut -d'/' -f1
  register: last_container_ip
  retries: 10
  delay: 10

- debug: 
    msg: 
      - "Last Virtual Machine: Id:{{ last_vm_id }} <> Name:{{ last_vm_name }} <> Ip:{{ last_vm_ip }}"
      - "Last Container Id:{{ last_container_id }} <> Name:{{ last_container_name }} <> Ip:{{ last_container_ip }}"

